---
// src/pages/[...slug].astro
import BaseLayout from "../layouts/BaseLayout.astro";
import YoutubePlayer from "../components/YoutubePlayer.jsx";
import SanityPicture from "../components/SanityPicture.astro";
import Play from "../components/Play.astro";

export const prerender = true;

import type { SanityDocument } from "@sanity/client";
import { loadQuery } from "../sanity/lib/load-query";

export async function getStaticPaths() {
  const { data: games } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "games"] {
      slug
    }`,
  });

  return games.map(({ slug }) => {
    return {
      params: {
        slug: slug.current,
      },
    };
  });
}
const { params } = Astro;

interface Game {
  name: string;
  description: string;
  youtubeLink: string;
  slug: { current: string };
  image: any;
  tag: { name: string; title: string };
}

const { data: game } = await loadQuery<Game>({
  query: `*[_type == "games" && slug.current == $slug][0]{
    name,
    description,
    youtubeLink,
    slug,
    image,
    tag->{name, title}
  }`,
  params,
});

// Données temporaires - à ajouter dans Sanity plus tard
const gameMetadata = {
  players: "1 à 4",
  duration: "60 min",
  difficulty: 3, // sur 5
  age: "16+",
  tags: ["Horreur", "Escape Room", "Coop"], // À remplacer par les vrais tags
};
---

<BaseLayout>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">
      <!-- Image à gauche -->
      <div class="relative rounded-2xl overflow-hidden shadow-2xl">
        {game.image && (
          <SanityPicture
            image={game.image}
            alt={game.name}
            className="w-full h-auto"
          />
        )}
      </div>

      <!-- Détails à droite -->
      <div class="flex flex-col gap-6">
        <div>
          <h1 class="text-4xl lg:text-5xl font-bold text-white mb-4">
            {game.name}
          </h1>

          <!-- Tags -->
          <div class="flex flex-wrap gap-2 mb-6">
            {gameMetadata.tags.map((tag) => (
              <span class="px-3 py-1 text-sm border border-blue-400 text-blue-400 rounded-full">
                {tag}
              </span>
            ))}
          </div>

          <!-- Métadonnées -->
          <div class="space-y-3 text-white">
            <div class="flex items-center gap-2">
              <span class="font-semibold">De {gameMetadata.players} joueurs</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-semibold">Durée :</span>
              <span>{gameMetadata.duration}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-semibold">Difficulté :</span>
              <div class="flex gap-1">
                {Array.from({ length: 5 }).map((_, i) => (
                  <div
                    class={`w-3 h-3 rounded-full border border-white ${
                      i < gameMetadata.difficulty ? 'bg-white' : 'bg-transparent'
                    }`}
                  />
                ))}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-semibold">Age conseillé :</span>
              <span>{gameMetadata.age}</span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="text-white space-y-4">
          <p class="text-lg leading-relaxed">{game.description}</p>
        </div>

        <!-- Boutons d'action -->
        <div class="flex flex-wrap gap-4 mt-4">
          <button
            onclick={`document.getElementById('video-modal').classList.remove('hidden')`}
            class="flex items-center gap-2 px-6 py-3 border-2 border-white text-white rounded-lg hover:bg-white hover:text-gray-900 transition-colors"
          >
            <Play size={24} />
            Voir la vidéo
          </button>
          <a
            href="/reservation"
            class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg transition-shadow"
          >
            Réserver
          </a>
        </div>
      </div>
    </div>

    <!-- Sections de description supplémentaires -->
    <div class="mt-16 space-y-8 text-white max-w-4xl">
      <div>
        <p class="text-lg leading-relaxed">
          Plongez dans l'univers glaçant de {game.name}, un escape room en réalité virtuelle conçu pour tester
          vos nerfs et votre esprit d'équipe.
        </p>
      </div>
    </div>
  </div>

  <!-- Modal vidéo -->
  <div
    id="video-modal"
    class="fixed inset-0 bg-black/90 z-50 hidden"
    onclick="this.classList.add('hidden')"
  >
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="w-full max-w-5xl" onclick="event.stopPropagation()">
        <div class="flex justify-end mb-4">
          <button
            onclick="document.getElementById('video-modal').classList.add('hidden')"
            class="text-white text-4xl hover:text-gray-300"
          >
            ×
          </button>
        </div>
        {game.youtubeLink && (
          <YoutubePlayer videoId={game.youtubeLink} client:load />
        )}
      </div>
    </div>
  </div>
</BaseLayout>
