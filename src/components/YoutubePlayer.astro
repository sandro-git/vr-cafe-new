---
// src/components/YoutubePlayer.astro
interface Props {
  videoId: string;
}

const { videoId } = Astro.props;

// Construire les URLs des thumbnails YouTube
const primaryThumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
const fallbackThumbnail = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
---

<div class="youtube-container w-full aspect-video relative rounded-lg overflow-hidden" data-video-id={videoId}>
  <button
    class="youtube-placeholder cursor-pointer relative w-full h-full border-0 p-0 bg-transparent focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-offset-2 rounded-lg transition-all"
    aria-label="Lire la vidéo YouTube"
    type="button"
  >
    <img
      src={primaryThumbnail}
      alt=""
      class="youtube-thumbnail w-full h-full object-cover"
      data-fallback={fallbackThumbnail}
    />
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
      <div class="play-button w-16 h-16 bg-red-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8 text-white"
          viewBox="0 0 24 24"
          fill="currentColor"
          aria-hidden="true"
        >
          <path d="M8 5v14l11-7z"></path>
        </svg>
      </div>
    </div>
    <div class="absolute bottom-0 left-0 right-0 text-center py-2 bg-black bg-opacity-50 text-white pointer-events-none">
      Cliquez pour lancer la vidéo en plein écran
    </div>
  </button>
</div>

<script>
  // Handle all YouTube players on the page
  document.querySelectorAll('.youtube-container').forEach((container) => {
    const placeholder = container.querySelector('.youtube-placeholder');
    const thumbnail = container.querySelector('.youtube-thumbnail');
    const videoId = container.getAttribute('data-video-id');

    if (!placeholder || !thumbnail || !videoId) return;

    // Handle thumbnail fallback
    thumbnail.addEventListener('error', () => {
      const fallback = thumbnail.getAttribute('data-fallback');
      if (fallback) {
        thumbnail.setAttribute('src', fallback);
      }
    });

    // Handle click to play
    placeholder.addEventListener('click', () => {
      const youtubeUrl = `https://www.youtube.com/embed/${videoId}?rel=0&showinfo=0&autoplay=1`;

      const iframe = document.createElement('iframe');
      iframe.src = youtubeUrl;
      iframe.className = 'w-full h-full absolute top-0 left-0';
      iframe.setAttribute('allowfullscreen', '');
      iframe.setAttribute('loading', 'lazy');
      iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
      iframe.setAttribute('title', 'Lecteur vidéo YouTube');

      // Replace placeholder with iframe
      container.innerHTML = '';
      container.appendChild(iframe);

      // Try to go fullscreen after a delay
      setTimeout(() => {
        try {
          if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
          } else if ((iframe as any).webkitRequestFullscreen) {
            (iframe as any).webkitRequestFullscreen();
          } else if ((iframe as any).msRequestFullscreen) {
            (iframe as any).msRequestFullscreen();
          }
        } catch (e) {
          console.error('Impossible de passer en plein écran:', e);
        }
      }, 1000);
    });
  });
</script>
